<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>StorjCORE Tutorial: Transferring File Shards</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.dark.css">

	<link type="text/css" rel="stylesheet" href="styles/site.cosmo.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top ">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">StorjCORE</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-storj.html">storj</a></li><li><a href="module-storj_constants.html">storj/constants</a></li><li><a href="module-storj_utils.html">storj/utils</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="AuditStream.html">AuditStream</a></li><li><a href="Contact.html">Contact</a></li><li><a href="Contract.html">Contract</a></li><li><a href="DataChannelClient.html">DataChannelClient</a></li><li><a href="DataChannelServer.html">DataChannelServer</a></li><li><a href="DataCipherKeyIv.html">DataCipherKeyIv</a></li><li><a href="DecryptStream.html">DecryptStream</a></li><li><a href="EncryptStream.html">EncryptStream</a></li><li><a href="FarmerInterface.html">FarmerInterface</a></li><li><a href="FileDemuxer.html">FileDemuxer</a></li><li><a href="FileMuxer.html">FileMuxer</a></li><li><a href="KeyPair.html">KeyPair</a></li><li><a href="KeyRing.html">KeyRing</a></li><li><a href="LevelDBFileStore.html">LevelDBFileStore</a></li><li><a href="LevelDBStorageAdapter.html">LevelDBStorageAdapter</a></li><li><a href="Manager.html">Manager</a></li><li><a href="Network.html">Network</a></li><li><a href="Padder.html">Padder</a></li><li><a href="ProofStream.html">ProofStream</a></li><li><a href="Protocol.html">Protocol</a></li><li><a href="RAMStorageAdapter.html">RAMStorageAdapter</a></li><li><a href="RateLimiter.html">RateLimiter</a></li><li><a href="RenterInterface.html">RenterInterface</a></li><li><a href="StorageAdapter.html">StorageAdapter</a></li><li><a href="StorageItem.html">StorageItem</a></li><li><a href="StorageMigration.html">StorageMigration</a></li><li><a href="Transport.html">Transport</a></li><li><a href="TunnelClient.html">TunnelClient</a></li><li><a href="TunnelDemuxer.html">TunnelDemuxer</a></li><li><a href="TunnelerInterface.html">TunnelerInterface</a></li><li><a href="TunnelGateway.html">TunnelGateway</a></li><li><a href="TunnelMuxer.html">TunnelMuxer</a></li><li><a href="TunnelServer.html">TunnelServer</a></li><li><a href="Unpadder.html">Unpadder</a></li><li><a href="Verification.html">Verification</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="events.list.html" class="dropdown-toggle" data-toggle="dropdown">Events<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="AuditStream.html#event:finish">AuditStream#event:finish</a></li><li><a href="DecryptStream.html#event:data">DecryptStream#event:data</a></li><li><a href="DecryptStream.html#event:end">DecryptStream#event:end</a></li><li><a href="EncryptStream.html#event:data">EncryptStream#event:data</a></li><li><a href="EncryptStream.html#event:end">EncryptStream#event:end</a></li><li><a href="FarmerInterface.html#event:ready">FarmerInterface#event:ready</a></li><li><a href="FileDemuxer.html#event:finish">FileDemuxer#event:finish</a></li><li><a href="FileDemuxer.html#event:shard">FileDemuxer#event:shard</a></li><li><a href="FileMuxer.html#event:drain">FileMuxer#event:drain</a></li><li><a href="Manager.html#event:locked">Manager#event:locked</a></li><li><a href="Manager.html#event:unlocked">Manager#event:unlocked</a></li><li><a href="Network.html#event:ready">Network#event:ready</a></li><li><a href="RenterInterface.html#event:ready">RenterInterface#event:ready</a></li><li><a href="TunnelClient.html#event:close">TunnelClient#event:close</a></li><li><a href="TunnelClient.html#event:open">TunnelClient#event:open</a></li><li><a href="TunnelerInterface.html#event:ready">TunnelerInterface#event:ready</a></li><li><a href="TunnelGateway.html#event:close">TunnelGateway#event:close</a></li><li><a href="TunnelGateway.html#event:message/datachannel">TunnelGateway#event:message/datachannel</a></li><li><a href="TunnelGateway.html#event:message/rpc">TunnelGateway#event:message/rpc</a></li><li><a href="TunnelGateway.html#event:open">TunnelGateway#event:open</a></li><li><a href="TunnelServer.html#event:locked">TunnelServer#event:locked</a></li><li><a href="TunnelServer.html#event:ready">TunnelServer#event:ready</a></li><li><a href="TunnelServer.html#event:unlocked">TunnelServer#event:unlocked</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="tutorials.list.html" class="dropdown-toggle" data-toggle="dropdown">Tutorials<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="tutorial-contract-topics.html">Publishing Storage Contracts</a></li><li><a href="tutorial-data-channels.html">Transferring File Shards</a></li><li><a href="tutorial-private-testnet.html">Running a Test Network</a></li><li><a href="tutorial-protocol-spec.html">Protocol Specification</a></li><li><a href="tutorial-renting-data.html">Renting Data to the Network</a></li><li><a href="tutorial-tunnel-connections.html">Tunnelling Connections</a></li>
				</ul>
			</li>
			
		</ul>
		<div class="col-sm-3 col-md-3">
            <form class="navbar-form" role="search">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                    <div class="input-group-btn">
                        <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                    </div>
                </div>
            </form>
        </div>
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			<section class="tutorial-section">

<header>
    

    <h2>Transferring File Shards</h2>
</header>

<article>
    <p>Nodes on the Storj network implement a separate &quot;data channel&quot; for file
transfer. Each node must expose a
<a href="https://tools.ietf.org/html/rfc6455">WebSocket</a> server that accepts connections
from clients who wish to use the channel for shard consignments and retrieval.</p>
<p>The WebSocket server must be accessible at the same path as the JSON-RPC server
and is negotiated by sending the <code>Sec-WebSocket-Key</code> header to indicate the
connection upgrade as defined by RFC6455. Once the WebSocket connection is
open, the client must send a JSON formatted message including the necessary
information for the farmer to authorize the data channel.</p>
<h3>Authorizing a Channel</h3><p>The JSON message the client must provide to the farmer before establishing the
channel must contain the <code>token</code> provided from a previous <code>CONSIGN</code> or
<code>RETRIEVE</code> request, the <code>hash</code> of the data being transferred, and the
<code>operation</code> (either <code>PUSH</code> or <code>PULL</code>).</p>
<pre class="prettyprint source"><code>{
  &quot;token&quot;: &quot;5a7ac2dd58377085bad57f864b3a493c288b7c07&quot;,
  &quot;hash&quot;: &quot;ba084d3f143f2896809d3f1d7dffed472b39d8de&quot;,
  &quot;operation&quot;: &quot;PUSH&quot;
}</code></pre><blockquote>
<p>Authorization message frames must use opcode <code>0x1</code> (textual).</p>
</blockquote>
<p>The receiving farmer must check that she issued the received <code>token</code> within a
reasonable amount of time (recommend 10 minutes) and that the supplied <code>hash</code> is
associated with that token before sending or receiving any other data.</p>
<p>If the authorization fails, the farmer must close the data channel, optionally
responding with a status message.</p>
<h3>Status Messages</h3><p>Farmers can communicate their status or the result of an operation by sending
JSON formatted messages including <code>code</code> (HTTP status code) and <code>message</code>.</p>
<pre class="prettyprint source"><code>{
  &quot;code&quot;: 200,
  &quot;message&quot;: &quot;Data consigned successfully&quot;
}</code></pre><pre class="prettyprint source"><code>{
  &quot;code&quot;: 401,
  &quot;message&quot;: &quot;Failed to authorize channel&quot;
}</code></pre><blockquote>
<p>Status message frames must use opcode <code>0x1</code> (textual).</p>
</blockquote>
<h3>Consigning a Shard</h3><p>To consign a shard (to upload the shard to a farmer), first send the
appropriate authorization message. If the farmer does not respond with a failed
status message, the channel is open and you can begin sending binary frames.</p>
<p>Farmers must track the amount of data received and ensure that it does not
exceed the amount defined in the contract. Once the farmer has received the
number of bytes defined in the contract, she must verify the data against the
hash defined in the contract.</p>
<p>If these checks are successfully executed, then the farmer must respond with a
positive status message and terminate the channel.</p>
<blockquote>
<p>Shard message frames must use opcode <code>0x2</code> (binary).</p>
</blockquote>
<h4>Example (browser-based)</h4><pre class="prettyprint source"><code>var channel = new WebSocket('&lt;farmer_uri>');

channel.addEventListener('open', function() {
  channel.send(JSON.stringify({
    token: '&lt;token>',
    hash: '&lt;hash>',
    operation: 'PUSH'
  });

  channel.send(new Blob([/* ... */]));
});

channel.addEventListener('message', function(e) {
  var data = JSON.parse(e.data);

  if (data.code && data.code !== 200) {
    console.error('Error consigning data:', data.message);
  } else {
    console.log('Successfully consigned data!');
  }
});</code></pre><h3>Retrieving a Shard</h3><p>To retrieve a shard from a farmer, first send the appropriate authorization
message. The farmer will respond with a negative status message frame if you
are not authorized and terminate the channel. If authorization is successful,
you will immediately begin receiving binary message frames until there is no
more data to be transferred - at which point the farmer must terminate the
channel.</p>
<blockquote>
<p>Shard message frames must use opcode <code>0x2</code> (binary).</p>
</blockquote>
<h4>Example (browser-based)</h4><pre class="prettyprint source"><code>var channel = new WebSocket('&lt;farmer_uri>');
var fileparts = [];

channel.addEventListener('open', function() {
  channel.send(JSON.stringify({
    token: '&lt;token>',
    hash: '&lt;hash>',
    operation: 'PULL'
  });
});

channel.addEventListener('message', function(e) {
  fileparts.push(e.data);
});

channel.addEventListener('close', function() {
  var file = new Blob(fileparts, { type: '&lt;mime_type>' });
  var url = URL.createObjectURL(file);

  location.href = url;
});</code></pre><h3>File Reconstruction</h3><p>In most cases a complete file is consigned to a number of different farmers. To
reconstruct a file, you'll need to know the location of each shard and the
concatenation order. With this information, you can open data channels to each
of the farmers storing the file's shards (with whatever degree of parallelism
suits your needs) and concatenate the binary blobs received in the proper order.</p>
</article>

</section>

		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>

<div class="modal fade" id="searchResults">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search results</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>

<footer>


	<span class="copyright">
	Copyright 2016 Storj Labs
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>
<script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : false,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


<script type="text/javascript">
	$(document).ready(function() {
		SearcherDisplay.init();
	});
</script>

</body>
</html>